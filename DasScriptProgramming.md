## DAS-scripting guide ##

### Script operators ###

_Script operators list:_
| **operators**  | **description** | **parameters** | **example** |
|:---------------|:----------------|:---------------|:------------|
| execute    | execute query via provider | node contents: query to execute<br />attributes: see in table below | <font color='green'>Select from table using SQL providers:</font><br><code>&lt;execute&gt;SELECT "id", "name", "description" FROM "users"&lt;/execute&gt;</code><br /><font color='green'>Invoke service operation using Services provider:</font><br><code>&lt;execute&gt;Add(nA=$a, nB=$b)&lt;/execute&gt;</code><br /><font color='green'>Invoke shell command using Shell provider:</font><br><code>&lt;execute&gt;ls $(directory)&lt;/execute&gt;</code> <br>
<tr><td> var        </td><td> declare or modify a variable </td><td> "name" - variable name<br><i>"value" - variable value (expression)</i><br><i>"type"- variable type (DataObject by default if no value defined)</i> </td><td> <font color='green'>Declare/modify int variable:</font><br> <code>&lt;var name="result" value="100" type="int" /&gt;</code><br /> <font color='green'>Put query result into variable (DataObject type):</font><br><code>&lt;var name="queryResult"&gt;</code><br><dd><code>&lt;execute&gt;SELECT * FROM tableName&lt;/execute&gt;</code></dd><code>&lt;/var&gt;</code><br /><font color='green'>Now you could get access to each field using:</font><br><code> ${queryResult.field1} </code><br /><font color='green'>Set field value of complex type:</font><br><code> &lt;var name="result" type="MyStruct" /&gt; </code><br><code> &lt;var name="result.field1" value="some value" /&gt; </code> </td></tr>
<tr><td> ifeq/ifneq </td><td> process conditional operator.<br> process content operators if expressions are equal(ifeq) or not equal(ifneq) </td><td> "expr1" - expression 1<br>"expr2" - expression 2<br> </td><td> <font color='green'>Insert into table if variable <code>value</code> is not empty:</font><br><code>&lt;ifneq expr1="${value}" expr2="" &gt;</code><br><dd><code>&lt;execute&gt;INSERT INTO values(name) VALUES('${value}')&lt;/execute&gt;</code></dd><code>&lt;/ifneq&gt;</code> </td></tr>
<tr><td> if/then/else </td><td> perform number or string comparasion </td><td> "expr1" - expression 1<br>"expr2" - expression 2<br>"op" - <a href='DasScriptProgramming#Comparison_operators:.md'>comparison operator</a><br> </td><td> <font color='green'>Process conditional operator:</font><br><code>&lt;if expr1="${var1}" expr2="${var1}" op="gt"&gt;</code><br><dd><code>&lt;then&gt;&lt;log&gt;var1 is greater than var2 &lt;/log&gt;&lt;/then&gt;</code></dd><dd><code>&lt;else&gt;&lt;log&gt;var1 is lesser or equal to var2 &lt;/log&gt;&lt;/else&gt;</code></dd><code>&lt;/if&gt;</code> </td></tr>
<tr><td> switch/case </td><td> perform selection among multiple sections </td><td> switch "expr" - expression to select<br>case "expr" - expression with block </td><td> <font color='green'>Process selection:</font><br><code>&lt;switch expr="${var}"&gt;</code><br><dd><code>&lt;case expr="1"&gt;&lt;log&gt;var == 1&lt;/log&gt;&lt;/case&gt;</code></dd><dd><code>&lt;case expr="2"&gt;&lt;log&gt;var == 2&lt;/log&gt;&lt;/case&gt;</code></dd><dd><code>&lt;default&gt;&lt;log&gt;var != 1 and var != 2&lt;/log&gt;&lt;/default&gt;</code></dd><code>&lt;/switch&gt;</code> </td></tr>
<tr><td> foreach    </td><td> iterate through elements </td><td> <i>"element" - child element "$(elem)" or complex variable name "$<code>[</code>var<code>]</code>" to iterate</i> </td><td> <font color='green'>Insert several records using foreach operator:</font><br><code>&lt;foreach element="$(identifiers)"&gt;</code><br><dd><code>&lt;execute&gt;INSERT INTO users "id", "name", "description" VALUES('$nodeValue', 'user_$nodeValue', 'autogenerated user # $nodeValue')&lt;/execute&gt;</code></dd><code>&lt;/foreach&gt;</code> </td></tr>
<tr><td> return     </td><td> set return value and break script execution </td><td> <i>"var" - variable name to return</i> </td><td> <font color='green'>Return value for datasource's operation:</font><br><code>&lt;return var="result" /&gt;</code><br /><font color='green'>Return single field value from DataObject-typed variable:</font><br><code>&lt;return var="${queryResult.field1}" /&gt;</code><br /><font color='green'>Return generic type expression:</font><br><code>&lt;return&gt;Calculated result = ${result}&lt;/return&gt;</code> </td></tr>
<tr><td> log        </td><td> output evaluated message to axis2/c console </td><td> log text in subnode </td><td> <font color='green'>Write message to log:</font><br><code>&lt;log&gt;a=${a}, b=${b}&lt;/log&gt;</code> </td></tr>
<tr><td> try/catch  </td><td> processes <code>&lt;try&gt;</code> block, if some fault occur will be executed <code>&lt;catch&gt;</code> block </td><td> <i>none</i> </td><td> <font color='green'>Example: bulk insertion within transaction. Rollback transaction on fault:</font><br /><code>&lt;trycatch&gt;</code><br><code>&lt;try&gt;</code><br><dd><code>&lt;execute&gt;BEGIN&lt;/execute&gt;</code></dd><dd><code>&lt;execute&gt;INSERT INTO table1(col1, col2) VALUES(${val11}, ${val12})&lt;/execute&gt;</code></dd><dd><code>&lt;execute&gt;INSERT INTO table2(col1, col2) VALUES(${val21}, ${val22})&lt;/execute&gt;</code></dd><dd><code>&lt;execute&gt;COMMIT&lt;/execute&gt;</code></dd><code>&lt;/try&gt;</code><br><code>&lt;!-- variable name is optional --&gt;</code><br><code>&lt;catch var="ex"&gt;</code><br><dd><code>&lt;log&gt;Exception occured: "${ex}". Rolling transaction back.&lt;/log&gt;</code><br><dd><code>&lt;execute&gt;ROLLBACK&lt;/execute&gt;</code></dd><code>&lt;/catch&gt;</code><br><code>&lt;/trycatch&gt;</code> </td></tr></tbody></table>


<code>*</code> parameters marked <i>italic</i> are optional<br>
<br />

<h3>Execute attributes:</h3>
<table><thead><th> <b>name</b>  </th><th> <b>description</b> </th><th> <b>values</b> </th><th> <b>example</b> </th></thead><tbody>
<tr><td> trim    </td><td> trims resulting string </td><td> "true" - enable resulting string trimming, any other - disable </td><td> <font color='green'>remove trailing and leading white spaces:</font><br><code>&lt;execute trim="true"&gt;echo "  text  "&lt;/execute&gt;</code> </td></tr>
<tr><td> result  </td><td> controls result value checking </td><td> "optional" - do not check result (default)<br> "required" - if result is empty, throw fault<br> "create" - if result is empty, create structure with null values </td><td> <font color='green'>disallow empty select result:</font><br><code>&lt;execute result="required"&gt;SELECT name FROM users WHERE id=$(id)&lt;/execute&gt;</code> </td></tr>
<tr><td> partial  </td><td> used to read only first few fields of structure </td><td> "true" - read only N first fields of struct which is present in result<br> "false" (default) - if number of structure fields not equal to number of result fields, throw fault </td><td> <font color='green'>select only id and name from user:</font><br><code>&lt;var name="user" type="User"&gt;</code><br><dd><code>&lt;execute partial="true"&gt;SELECT id, name FROM users WHERE id=$(id)&lt;/execute&gt;</code></dd><code>&lt;/var&gt;</code> </td></tr></tbody></table>

<h3>Comparison operators:</h3>
<b>Those operators can be used when comparing numbers</b>
<table><thead><th> <b>name</b>             </th><th> gt  </th><th> lt  </th><th> ge   </th><th> le   </th><th> eq   </th><th> ne   </th></thead><tbody>
<tr><td> <b>C/C++ equivalent</b> </td><td> <code>&gt;</code> </td><td> <code>&lt;</code> </td><td> <code>&gt;=</code> </td><td> <code>&lt;=</code> </td><td> <code>==</code> </td><td> <code>!=</code> </td></tr></tbody></table>

<b>Those operators can be used when comparing strings</b>
<table><thead><th> <b>name</b>             </th><th> sgt </th><th> slt </th><th> sge  </th><th> sle  </th><th> seq  </th><th> sne  </th></thead><tbody>
<tr><td> <b>C/C++ equivalent</b> </td><td> <code>&gt;</code> </td><td> <code>&lt;</code> </td><td> <code>&gt;=</code> </td><td> <code>&lt;=</code> </td><td> <code>==</code> </td><td> <code>!=</code> </td></tr></tbody></table>

<h3>Evaluating expressions</h3>

<code>${variable_name}</code> or <code>$variable_name</code> - replace placeholder to variable value. Use parameter binding for SQL providers.<br>
<br>
<code>${!variable_name}</code> - replace placeholder to variable value. Stringize variable's value into query. Use with care - this may cause SQL injection if variable is calculated from Operation's request.<br>
<br>
<code>${variable_name.child_name}</code> - replace placeholder to variable's child value (while using DataObject-typed variables)<br>
<br>
<code>$(element.name)</code> - replace placeholder to given request's element value<br>
<br>
<code>$[element.name]</code> - replace parameter to given request's element.<br>
<br>
<b>Note:</b> To quote '$' sign you could use backslash '\' symbol:<br>
<pre><code>  &lt;execute&gt;sh -c 'echo -n \$(($(a) + $(b)))'&lt;/execute&gt;<br>
</code></pre>

<b>Note 2:</b> If you declare <code>type</code> attribute variable's value will be cleared immediately. While having list/DataObject variable type, variable's value <i>replaced</i> by new one (if any).<br>
<br>
If you don't declare <code>type</code>, old value will be kept. In case you have list/DataObject type new value will be <i>appended</i> to existing.<br>
<br>
<br>
<h3>Example of using the variables</h3>

request to the datasource is:<br>
<br>
<pre><code>&lt;Test&gt;&lt;Info&gt;&lt;Id&gt;123&lt;/Id&gt;&lt;Name&gt;test name&lt;/Name&gt;&lt;/Info&gt;&lt;/Test&gt;<br>
</code></pre>

variable "a" is declared as:<br>
<br>
<pre><code>&lt;var name="a" value="test" /&gt;<br>
</code></pre>

expression:<br>
<br>
<pre><code>variable a="${a}" and Test info id = $(Info.Id), name="$(Info.Name)"<br>
</code></pre>

evaluated expression will be:<br>
<br>
<pre><code>variable a="test" and Test info id = 123, name="test name"<br>
</code></pre>
<h3>Special variables</h3>

There are two special variables that you may use to store data globally or per session.<br>
<br>
<ul><li>"global" - global data storage - for all users and all DAS services.<br>
</li><li>"session" - session data storage - accessible only within current session.</li></ul>

session has read-only variable named "id" which is used to get current session id from DAS service.<br>
<br>
<br>
<h3>Using of special variables</h3>

Get current session id:<br>
<br>
<pre><code>&lt;log&gt;sessionId = ${session.id}&lt;/log&gt;<br>
</code></pre>


Write into global storage:<br>
<br>
<pre><code>&lt;var name="global.webServerRoot" value="https://myserver.example.com/root/"/&gt;<br>
</code></pre>

Get user name on creating session and save it to session data storage:<br>
<br>
<pre><code>&lt;provider name="staff.das.Sqlite" id="staff"&gt;<br>
  &lt;connection&gt;<br>
    &lt;db&gt;$(STAFF_HOME)/db/staff.db&lt;/db&gt;<br>
  &lt;/connection&gt;<br>
<br>
  &lt;!-- this script is executed when this datasource is loaded --&gt;<br>
  &lt;oncreate&gt;<br>
    &lt;script&gt;<br>
      &lt;var name="session.userName" type="string"&gt;<br>
        &lt;execute&gt;<br>
          SELECT u.name FROM users u<br>
          LEFT JOIN sessions s ON s.userId = u.id<br>
          WHERE s.sessionId = ${session.id}<br>
        &lt;/execute&gt;<br>
      &lt;/var&gt;<br>
    &lt;/script&gt;<br>
  &lt;/oncreate&gt;<br>
&lt;/provider&gt;<br>
</code></pre>

Next you may use it somewhere in service:<br>
<br>
<pre><code>&lt;log&gt;user name = ${session.userName}&lt;/log&gt;<br>
</code></pre>